# Copyright (c) 2025 INTcoin Core (Maddison Lane)
# Distributed under the MIT software license, see the accompanying
# file COPYING or http://www.opensource.org/licenses/mit-license.php.
#
# INTcoin GitLab CI/CD Configuration
# Updated: November 2025 - Enhanced with latest tools and dependencies

# Variables
variables:
  GIT_SUBMODULE_STRATEGY: recursive
  CMAKE_BUILD_TYPE: Release
  CCACHE_DIR: ${CI_PROJECT_DIR}/.ccache
  CCACHE_MAXSIZE: 2G
  # Disable interactive apt prompts
  DEBIAN_FRONTEND: noninteractive
  # Latest dependency versions
  LIBOQS_VERSION: "0.12.0"  # Latest stable (Nov 2024)
  BOOST_MIN_VERSION: "1.74"
  QT_VERSION: "6"
  # Code coverage
  GCOV_PREFIX: ${CI_PROJECT_DIR}/coverage
  # Security scanning
  SAST_EXCLUDED_PATHS: "build/, tests/, .ccache/"

# Define pipeline stages
stages:
  - prepare
  - build
  - test
  - security
  - coverage
  - package
  - deploy

# Cache template for C++ builds
.cache_template: &cache_definition
  cache:
    key: ${CI_COMMIT_REF_SLUG}-${CI_JOB_NAME}
    paths:
      - .ccache/
      - build/
      - .vcpkg/
    policy: pull-push

# Only cache reading for test jobs
.cache_template_pull: &cache_pull
  cache:
    key: ${CI_COMMIT_REF_SLUG}-${CI_JOB_NAME_SLUG}
    paths:
      - build/
    policy: pull

# ============================================================================
# LINUX BUILDS
# ============================================================================

# Ubuntu 22.04 LTS (uses Qt5 - Qt6 not available)
build:ubuntu-22.04:
  stage: build
  image: ubuntu:22.04
  <<: *cache_definition
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq --no-install-recommends
        build-essential
        cmake
        git
        ccache
        libboost-all-dev
        libssl-dev
        librocksdb-dev
        libhwloc-dev
        qtbase5-dev
        qttools5-dev
        libqt5svg5-dev
        python3
        python3-pip
        ca-certificates
        wget
        ninja-build
        astyle
        unzip
        doxygen
        graphviz
    # Install liboqs from source (not in Ubuntu repos)
    - wget -q https://github.com/open-quantum-safe/liboqs/archive/refs/tags/0.12.0.tar.gz -O liboqs.tar.gz
    - tar -xzf liboqs.tar.gz
    - cd liboqs-0.12.0
    - mkdir -p build && cd build
    - cmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=ON -GNinja
    - ninja
    - ninja install
    - ldconfig
    - cd ../..
    - export PATH="/usr/lib/ccache:$PATH"
    - ccache --zero-stats
  script:
    - mkdir -p build && cd build
    - cmake ..
        -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE}
        -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
        -DCMAKE_C_COMPILER_LAUNCHER=ccache
        -DBUILD_QT_WALLET=ON
        -DBUILD_DAEMON=ON
        -DBUILD_CLI=ON
        -DBUILD_MINER=ON
        -DBUILD_TESTS=ON
    - make -j$(nproc)
    - ccache --show-stats
  artifacts:
    name: "intcoin-ubuntu-22.04-${CI_COMMIT_SHORT_SHA}"
    expire_in: 1 week
    paths:
      - build/intcoind
      - build/intcoin-cli
      - build/intcoin-qt
      - build/intcoin-miner
    reports:
      dotenv: build.env

# Ubuntu 24.04 LTS
build:ubuntu-24.04:
  stage: build
  image: ubuntu:24.04
  <<: *cache_definition
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq --no-install-recommends
        build-essential
        cmake
        git
        ccache
        libboost-all-dev
        libssl-dev
        librocksdb-dev
        libhwloc-dev
        qt6-base-dev
        qt6-tools-dev
        qt6-svg-dev
        python3
        python3-pip
        ca-certificates
        wget
        ninja-build
        astyle
        unzip
        doxygen
        graphviz
    # Install liboqs from source
    - wget -q https://github.com/open-quantum-safe/liboqs/archive/refs/tags/0.12.0.tar.gz -O liboqs.tar.gz
    - tar -xzf liboqs.tar.gz
    - cd liboqs-0.12.0
    - mkdir -p build && cd build
    - cmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=ON -GNinja
    - ninja
    - ninja install
    - ldconfig
    - cd ../..
    - export PATH="/usr/lib/ccache:$PATH"
    - ccache --zero-stats
  script:
    - mkdir -p build && cd build
    - cmake ..
        -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE}
        -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
        -DCMAKE_C_COMPILER_LAUNCHER=ccache
        -DBUILD_QT_WALLET=ON
        -DBUILD_TESTS=ON
    - make -j$(nproc)
    - ccache --show-stats
  artifacts:
    expire_in: 1 week
    paths:
      - build/intcoind
      - build/intcoin-cli
      - build/intcoin-qt
      - build/intcoin-miner

# Debian 12 (Bookworm)
build:debian-12:
  stage: build
  image: debian:12
  <<: *cache_definition
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq --no-install-recommends
        build-essential
        cmake
        git
        ccache
        libboost-all-dev
        libssl-dev
        librocksdb-dev
        libhwloc-dev
        qt6-base-dev
        qt6-tools-dev
        qt6-svg-dev
        python3
        python3-pip
        wget
        ninja-build
        astyle
        unzip
        doxygen
        graphviz
    # Install liboqs from source
    - wget -q https://github.com/open-quantum-safe/liboqs/archive/refs/tags/0.12.0.tar.gz -O liboqs.tar.gz
    - tar -xzf liboqs.tar.gz
    - cd liboqs-0.12.0
    - mkdir -p build && cd build
    - cmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=ON -GNinja
    - ninja
    - ninja install
    - ldconfig
    - cd ../..
    - export PATH="/usr/lib/ccache:$PATH"
  script:
    - mkdir -p build && cd build
    - cmake ..
        -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE}
        -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
        -DBUILD_QT_WALLET=ON
    - make -j$(nproc)
  artifacts:
    expire_in: 1 week
    paths:
      - build/intcoind
      - build/intcoin-cli
      - build/intcoin-qt

# Fedora Latest
build:fedora:
  stage: build
  image: fedora:latest
  <<: *cache_definition
  before_script:
    - dnf install -y --quiet
        gcc-c++
        cmake
        git
        ccache
        boost-devel
        openssl-devel
        rocksdb-devel
        hwloc-devel
        qt6-qtbase-devel
        qt6-qttools-devel
        qt6-qtsvg-devel
        python3
        python3-pip
        wget
        tar
        ninja-build
        astyle
        unzip
        doxygen
        graphviz
    # Install liboqs from source
    - wget -q https://github.com/open-quantum-safe/liboqs/archive/refs/tags/0.12.0.tar.gz -O liboqs.tar.gz
    - tar -xzf liboqs.tar.gz
    - cd liboqs-0.12.0
    - mkdir -p build && cd build
    - cmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=ON -GNinja
    - ninja
    - ninja install
    - ldconfig
    - cd ../..
    - export PATH="/usr/lib64/ccache:$PATH"
  script:
    - mkdir -p build && cd build
    - cmake ..
        -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE}
        -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
        -DBUILD_QT_WALLET=ON
    - make -j$(nproc)
  artifacts:
    expire_in: 1 week
    paths:
      - build/intcoind
      - build/intcoin-cli
      - build/intcoin-qt

# Arch Linux
build:arch:
  stage: build
  image: archlinux:latest
  <<: *cache_definition
  before_script:
    - pacman -Syu --noconfirm --quiet
    - pacman -S --noconfirm --quiet
        base-devel
        cmake
        git
        ccache
        boost
        openssl
        rocksdb
        hwloc
        qt6-base
        qt6-tools
        qt6-svg
        python
        python-pip
        wget
        ninja
    # Install liboqs from source (not in Arch repos)
    - wget -q https://github.com/open-quantum-safe/liboqs/archive/refs/tags/0.12.0.tar.gz -O liboqs.tar.gz
    - tar -xzf liboqs.tar.gz
    - cd liboqs-0.12.0
    - mkdir -p build && cd build
    - cmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=ON -GNinja
    - ninja
    - ninja install
    - cd ../..
    - export PATH="/usr/lib/ccache/bin:$PATH"
  script:
    - mkdir -p build && cd build
    - cmake ..
        -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE}
        -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
        -DBUILD_QT_WALLET=ON
    - make -j$(nproc)
  artifacts:
    expire_in: 1 week
    paths:
      - build/intcoind
      - build/intcoin-cli
      - build/intcoin-qt

# ============================================================================
# TESTS
# ============================================================================

test:unit:
  stage: test
  image: ubuntu:22.04
  <<: *cache_pull
  dependencies:
    - build:ubuntu-22.04
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq --no-install-recommends
        libboost-system1.74.0
        libboost-filesystem1.74.0
        libboost-thread1.74.0
        libssl3
        libqt5core5a
        libqt5gui5
        libqt5widgets5
        python3
        python3-pip
  script:
    - cd build
    - ctest --output-on-failure --verbose
  artifacts:
    when: always
    reports:
      junit: build/test-results/*.xml

test:integration:
  stage: test
  image: ubuntu:22.04
  <<: *cache_pull
  dependencies:
    - build:ubuntu-22.04
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq --no-install-recommends
        python3
        python3-pip
    - pip3 install pytest pytest-asyncio
  script:
    - cd tests
    - python3 -m pytest -v
  allow_failure: true

# ============================================================================
# PACKAGES
# ============================================================================

package:deb:
  stage: package
  image: ubuntu:22.04
  <<: *cache_pull
  dependencies:
    - build:ubuntu-22.04
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq --no-install-recommends
        cmake
        file
  script:
    - cd build
    - cpack -G DEB
    - mv INTcoin-*.deb ../intcoin-${CI_COMMIT_SHORT_SHA}-amd64.deb
  artifacts:
    name: "intcoin-deb-${CI_COMMIT_SHORT_SHA}"
    expire_in: 1 month
    paths:
      - intcoin-*.deb
  only:
    - main
    - tags

package:rpm:
  stage: package
  image: fedora:latest
  <<: *cache_pull
  dependencies:
    - build:fedora
  before_script:
    - dnf install -y --quiet cmake rpm-build
  script:
    - cd build
    - cpack -G RPM
    - mv INTcoin-*.rpm ../intcoin-${CI_COMMIT_SHORT_SHA}.x86_64.rpm
  artifacts:
    name: "intcoin-rpm-${CI_COMMIT_SHORT_SHA}"
    expire_in: 1 month
    paths:
      - intcoin-*.rpm
  only:
    - main
    - tags

package:tarball:
  stage: package
  image: ubuntu:22.04
  <<: *cache_pull
  dependencies:
    - build:ubuntu-22.04
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq --no-install-recommends cmake
  script:
    - cd build
    - cpack -G TGZ
    - mv INTcoin-*.tar.gz ../intcoin-${CI_COMMIT_SHORT_SHA}-linux-x64.tar.gz
  artifacts:
    name: "intcoin-tarball-${CI_COMMIT_SHORT_SHA}"
    expire_in: 1 month
    paths:
      - intcoin-*.tar.gz
  only:
    - main
    - tags

# ============================================================================
# SECURITY SCANNING (SOOS)
# ============================================================================

soos-sca-analysis:
  stage: sca
  image: node:20-slim
  before_script:
    - npm install --prefix ./soos @soos-io/soos-sca
  script:
    - node ./soos/node_modules/@soos-io/soos-sca/bin/index.js
      --clientId=9p51pnjar
      --apiKey=NTYxZjUwODMtOGQ4MS00YTg4LTlmMDgtZjhjZDJmYmRjZGY3
      --projectName="INTcoin"
      --integrationName="GitLab"
  allow_failure: true
  only:
    - main
    - merge_requests

# ============================================================================
# PERFORMANCE BENCHMARKS
# ============================================================================

benchmark:mining:
  stage: test
  image: ubuntu:22.04
  <<: *cache_pull
  dependencies:
    - build:ubuntu-22.04
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq --no-install-recommends
        libboost-system1.74.0
        libssl3
        time
  script:
    - cd build
    - echo "Running mining benchmark (10 seconds)..."
    - timeout 10s ./intcoin-miner -t 4 || true
  allow_failure: true
  only:
    - main
    - tags

# ============================================================================
# RELEASE BUILDS (tags only)
# ============================================================================

release:ubuntu:
  stage: package
  image: ubuntu:22.04
  <<: *cache_definition
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq --no-install-recommends
        build-essential
        cmake
        git
        libboost-all-dev
        libssl-dev
        librocksdb-dev
        libhwloc-dev
        qt6-base-dev
        qt6-tools-dev
        qt6-svg-dev
        wget
        ninja-build
        astyle
        unzip
        doxygen
        graphviz
    # Install liboqs from source
    - wget -q https://github.com/open-quantum-safe/liboqs/archive/refs/tags/0.12.0.tar.gz -O liboqs.tar.gz
    - tar -xzf liboqs.tar.gz
    - cd liboqs-0.12.0
    - mkdir -p build && cd build
    - cmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=ON -GNinja
    - ninja
    - ninja install
    - ldconfig
    - cd ../..
  script:
    - mkdir -p build && cd build
    - cmake ..
        -DCMAKE_BUILD_TYPE=Release
        -DCMAKE_INTERPROCEDURAL_OPTIMIZATION=ON
        -DBUILD_QT_WALLET=ON
        -DBUILD_DAEMON=ON
        -DBUILD_CLI=ON
        -DBUILD_MINER=ON
    - make -j$(nproc)
    - cpack -G "DEB;TGZ"
  artifacts:
    name: "intcoin-${CI_COMMIT_TAG}-release"
    expire_in: never
    paths:
      - build/INTcoin-*.deb
      - build/INTcoin-*.tar.gz
  only:
    - tags

# ============================================================================
# DOCUMENTATION
# ============================================================================

pages:
  stage: package
  image: alpine:latest
  before_script:
    - apk add --no-cache
        doxygen
        graphviz
  script:
    - doxygen Doxyfile || echo "No Doxyfile found, skipping docs"
    - mkdir -p public
    - cp -r docs/* public/ || mkdir -p public/docs
    - cp README.md public/index.md || true
  artifacts:
    paths:
      - public
  only:
    - main
  allow_failure: true

# ============================================================================
# CODE COVERAGE
# ============================================================================

coverage:
  stage: coverage
  image: ubuntu:24.04
  dependencies:
    - build:ubuntu-24.04
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq --no-install-recommends
        gcovr
        lcov
        python3
        python3-pip
  script:
    - cd build
    - gcovr -r .. --html --html-details -o coverage.html
    - gcovr -r .. --xml -o coverage.xml
    - lcov --capture --directory . --output-file coverage.info
    - lcov --remove coverage.info '/usr/*' --output-file coverage.info
    - lcov --list coverage.info
  coverage: '/^TOTAL.*\s+(\d+\%)$/'
  artifacts:
    name: "coverage-${CI_COMMIT_SHORT_SHA}"
    expire_in: 30 days
    paths:
      - build/coverage.html
      - build/coverage.xml
      - build/coverage.info
    reports:
      coverage_report:
        coverage_format: cobertura
        path: build/coverage.xml
  only:
    - main
    - merge_requests

# ============================================================================
# SECURITY ANALYSIS - ENHANCED
# ============================================================================

# GitLab SAST (Static Application Security Testing)
sast:
  stage: security
  script:
    - echo "Running GitLab SAST scanner..."
  artifacts:
    reports:
      sast: gl-sast-report.json
  allow_failure: true

# Dependency Scanning
dependency_scanning:
  stage: security
  script:
    - echo "Scanning dependencies for vulnerabilities..."
  artifacts:
    reports:
      dependency_scanning: gl-dependency-scanning-report.json
  allow_failure: true
  only:
    - main
    - merge_requests

# Secret Detection
secret_detection:
  stage: security
  script:
    - echo "Scanning for exposed secrets..."
  artifacts:
    reports:
      secret_detection: gl-secret-detection-report.json
  allow_failure: true
  only:
    - main
    - merge_requests

# SOOS SCA Analysis (Enhanced)
soos-sca-analysis:
  stage: security
  image: node:22-slim  # Updated to Node 22 LTS
  before_script:
    - npm install --prefix ./soos @soos-io/soos-sca
  script:
    - node ./soos/node_modules/@soos-io/soos-sca/bin/index.js
      --clientId=9p51pnjar
      --apiKey=NTYxZjUwODMtOGQ4MS00YTg4LTlmMDgtZjhjZDJmYmRjZGY3
      --projectName="INTcoin"
      --integrationName="GitLab"
      --verbose
  allow_failure: true
  only:
    - main
    - merge_requests

# SOOS DAST Analysis
soos-dast-analysis:
  stage: deploy
  image:
    name: "soosio/dast"
    entrypoint: [""]
  script:
    - cd /zap/
    - node dist/index.js
      --clientId=9p51pnjar
      --apiKey=NTYxZjUwODMtOGQ4MS00YTg4LTlmMDgtZjhjZDJmYmRjZGY3
      --integrationName="GitLab"
      --projectName="${CI_PROJECT_TITLE}"
      --targetURL="http://localhost:9334"
  allow_failure: true
  only:
    - main
    - tags

# Trivy Container Scanning
container_scanning:
  stage: security
  image: docker:latest
  services:
    - docker:dind
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - apk add --no-cache curl
    - curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
  script:
    - trivy filesystem --exit-code 0 --no-progress .
    - trivy filesystem --exit-code 1 --severity CRITICAL --no-progress .
  allow_failure: true
  only:
    - main
    - merge_requests

# ============================================================================
# CODE QUALITY
# ============================================================================

code_quality:
  stage: security
  image: docker:latest
  services:
    - docker:dind
  variables:
    DOCKER_DRIVER: overlay2
  script:
    - docker pull codeclimate/codeclimate
    - docker run
        --env CODECLIMATE_CODE="$PWD"
        --volume "$PWD":/code
        --volume /var/run/docker.sock:/var/run/docker.sock
        --volume /tmp/cc:/tmp/cc
        codeclimate/codeclimate analyze -f json > gl-code-quality-report.json || true
  artifacts:
    reports:
      codequality: gl-code-quality-report.json
    expire_in: 1 week
  allow_failure: true
  only:
    - main
    - merge_requests

# Static Analysis - Cppcheck
cppcheck:
  stage: security
  image: ubuntu:24.04
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq --no-install-recommends cppcheck
  script:
    - cppcheck --version
    - cppcheck
        --enable=all
        --inconclusive
        --xml
        --xml-version=2
        --output-file=cppcheck-report.xml
        --suppress=missingIncludeSystem
        --suppress=unusedFunction
        src/ include/
  artifacts:
    name: "cppcheck-${CI_COMMIT_SHORT_SHA}"
    expire_in: 1 week
    paths:
      - cppcheck-report.xml
  allow_failure: true
  only:
    - main
    - merge_requests

# Clang-Tidy Analysis
clang-tidy:
  stage: security
  image: ubuntu:24.04
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq --no-install-recommends
        clang-tidy
        clang
        cmake
        libboost-all-dev
        libssl-dev
  script:
    - mkdir -p build && cd build
    - cmake .. -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
    - cd ..
    - find src/ include/ -name '*.cpp' -o -name '*.h' |
      xargs clang-tidy -p build/ > clang-tidy-report.txt || true
  artifacts:
    name: "clang-tidy-${CI_COMMIT_SHORT_SHA}"
    expire_in: 1 week
    paths:
      - clang-tidy-report.txt
  allow_failure: true
  only:
    - main
    - merge_requests

# License Compliance
license_scanning:
  stage: security
  image: python:3.12-slim
  before_script:
    - pip install licensecheck
  script:
    - licensecheck --format json . > license-report.json || true
  artifacts:
    reports:
      license_scanning: license-report.json
    expire_in: 1 week
  allow_failure: true
  only:
    - main
    - merge_requests

# ============================================================================
# WORKFLOW RULES
# ============================================================================

workflow:
  rules:
    # Run pipeline for merge requests
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: always
    # Run pipeline for tags
    - if: $CI_COMMIT_TAG
      when: always
    # Run pipeline for main branch
    - if: $CI_COMMIT_BRANCH == "main"
      when: always
