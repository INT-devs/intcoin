name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  release:
    types: [ created ]

env:
  BUILD_TYPE: Release

jobs:
  # ============================================================================
  # Linux Build (Ubuntu)
  # ============================================================================
  build-ubuntu:
    name: Ubuntu 24.04
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          libssl-dev \
          libboost-all-dev \
          librocksdb-dev \
          libcurl4-openssl-dev \
          libsodium-dev \
          libjsoncpp-dev \
          libzmq3-dev \
          libevent-dev \
          libqrencode-dev \
          libhidapi-dev \
          libxkbcommon-dev \
          qt6-base-dev \
          qt6-tools-dev \
          qt6-tools-dev-tools \
          libqt6svg6-dev

    - name: Cache liboqs
      id: cache-liboqs
      uses: actions/cache@v4
      with:
        path: ~/liboqs
        key: ${{ runner.os }}-liboqs-0.15.0

    - name: Build liboqs
      if: steps.cache-liboqs.outputs.cache-hit != 'true'
      run: |
        git clone --branch 0.15.0 https://github.com/open-quantum-safe/liboqs.git ~/liboqs-src
        cd ~/liboqs-src
        mkdir build && cd build
        cmake -GNinja -DCMAKE_INSTALL_PREFIX=$HOME/liboqs -DCMAKE_BUILD_TYPE=Release ..
        ninja
        ninja install

    - name: Cache RandomX
      id: cache-randomx
      uses: actions/cache@v4
      with:
        path: ~/randomx
        key: ${{ runner.os }}-randomx-1.2.1

    - name: Build RandomX
      if: steps.cache-randomx.outputs.cache-hit != 'true'
      run: |
        git clone --branch v1.2.1 https://github.com/tevador/RandomX.git ~/randomx-src
        cd ~/randomx-src
        mkdir build && cd build
        cmake -DCMAKE_INSTALL_PREFIX=$HOME/randomx -DCMAKE_BUILD_TYPE=Release ..
        make -j$(nproc)
        make install

    - name: Configure CMake
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
          -DCMAKE_PREFIX_PATH="$HOME/liboqs;$HOME/randomx" \
          -DBUILD_TESTS=ON \
          -DBUILD_WALLET_QT=ON \
          -GNinja

    - name: Build
      run: cmake --build build --config $BUILD_TYPE -j$(nproc)

    - name: Run tests
      working-directory: build
      timeout-minutes: 30
      run: ctest --output-on-failure -C $BUILD_TYPE --timeout 300 -E "(MetricsServerTest|IBDIntegrationTest)"

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: intcoin-ubuntu-24.04
        path: |
          build/bin/intcoind
          build/bin/intcoin-cli
          build/bin/intcoin-wallet
          build/bin/intcoin-miner
          build/bin/intcoin-pool-server
          build/bin/intcoin-qt
        if-no-files-found: error

  # ============================================================================
  # macOS Build
  # ============================================================================
  build-macos:
    name: macOS Latest
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        brew update
        brew install cmake ninja openssl boost rocksdb qt@6 curl libsodium jsoncpp zeromq libevent qrencode hidapi

    - name: Cache liboqs
      id: cache-liboqs-macos
      uses: actions/cache@v4
      with:
        path: ~/liboqs
        key: ${{ runner.os }}-liboqs-0.15.0

    - name: Build liboqs
      if: steps.cache-liboqs-macos.outputs.cache-hit != 'true'
      run: |
        git clone --branch 0.15.0 https://github.com/open-quantum-safe/liboqs.git ~/liboqs-src
        cd ~/liboqs-src
        mkdir build && cd build
        cmake -GNinja -DCMAKE_INSTALL_PREFIX=$HOME/liboqs -DCMAKE_BUILD_TYPE=Release ..
        ninja
        ninja install

    - name: Cache RandomX
      id: cache-randomx-macos
      uses: actions/cache@v4
      with:
        path: ~/randomx
        key: ${{ runner.os }}-randomx-1.2.1

    - name: Build RandomX
      if: steps.cache-randomx-macos.outputs.cache-hit != 'true'
      run: |
        git clone --branch v1.2.1 https://github.com/tevador/RandomX.git ~/randomx-src
        cd ~/randomx-src
        mkdir build && cd build
        cmake -DCMAKE_INSTALL_PREFIX=$HOME/randomx -DCMAKE_BUILD_TYPE=Release ..
        make -j$(sysctl -n hw.ncpu)
        make install

    - name: Configure CMake
      run: |
        export Qt6_DIR=$(brew --prefix qt@6)/lib/cmake/Qt6
        cmake -B build \
          -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
          -DCMAKE_PREFIX_PATH="$HOME/liboqs;$HOME/randomx;$(brew --prefix qt@6)" \
          -DBUILD_TESTS=ON \
          -DBUILD_WALLET_QT=ON \
          -GNinja

    - name: Build
      run: cmake --build build --config $BUILD_TYPE -j$(sysctl -n hw.ncpu)

    - name: Run tests
      working-directory: build
      timeout-minutes: 30
      run: ctest --output-on-failure -C $BUILD_TYPE --timeout 300 -E "(MetricsServerTest|IBDIntegrationTest)"

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: intcoin-macos-latest
        path: |
          build/bin/intcoind
          build/bin/intcoin-cli
          build/bin/intcoin-wallet
          build/bin/intcoin-miner
          build/bin/intcoin-pool-server
          build/bin/intcoin-qt
        if-no-files-found: error

  # ============================================================================
  # Linux Build (Fedora)
  # ============================================================================
  build-fedora:
    name: Fedora 40
    runs-on: ubuntu-24.04
    container:
      image: fedora:40

    steps:
    - name: Install git for checkout
      run: dnf install -y git

    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        dnf install -y \
          gcc-c++ \
          cmake \
          ninja-build \
          openssl-devel \
          boost-devel \
          rocksdb-devel \
          libcurl-devel \
          libsodium-devel \
          jsoncpp-devel \
          zeromq-devel \
          libevent-devel \
          qrencode-devel \
          hidapi-devel \
          libxkbcommon-devel \
          qt6-qtbase-devel \
          qt6-qttools-devel \
          qt6-qtsvg-devel \
          git

    - name: Cache liboqs
      id: cache-liboqs-fedora
      uses: actions/cache@v4
      with:
        path: ~/liboqs
        key: fedora-liboqs-0.15.0

    - name: Build liboqs
      if: steps.cache-liboqs-fedora.outputs.cache-hit != 'true'
      run: |
        git clone --branch 0.15.0 https://github.com/open-quantum-safe/liboqs.git ~/liboqs-src
        cd ~/liboqs-src
        mkdir build && cd build
        cmake -GNinja -DCMAKE_INSTALL_PREFIX=$HOME/liboqs -DCMAKE_BUILD_TYPE=Release ..
        ninja
        ninja install

    - name: Cache RandomX
      id: cache-randomx-fedora
      uses: actions/cache@v4
      with:
        path: ~/randomx
        key: fedora-randomx-1.2.1

    - name: Build RandomX
      if: steps.cache-randomx-fedora.outputs.cache-hit != 'true'
      run: |
        git clone --branch v1.2.1 https://github.com/tevador/RandomX.git ~/randomx-src
        cd ~/randomx-src
        mkdir build && cd build
        cmake -DCMAKE_INSTALL_PREFIX=$HOME/randomx -DCMAKE_BUILD_TYPE=Release ..
        make -j$(nproc)
        make install

    - name: Configure CMake
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
          -DCMAKE_PREFIX_PATH="$HOME/liboqs;$HOME/randomx" \
          -DBUILD_TESTS=ON \
          -DBUILD_WALLET_QT=ON \
          -GNinja

    - name: Build
      run: cmake --build build --config $BUILD_TYPE -j$(nproc)

    - name: Run tests
      working-directory: build
      timeout-minutes: 30
      run: ctest --output-on-failure -C $BUILD_TYPE --timeout 300 -E "(MetricsServerTest|IBDIntegrationTest)"

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: intcoin-fedora-40
        path: |
          build/bin/intcoind
          build/bin/intcoin-cli
          build/bin/intcoin-wallet
          build/bin/intcoin-miner
          build/bin/intcoin-pool-server
          build/bin/intcoin-qt
        if-no-files-found: error

  # ============================================================================
  # Linux Build (Debian)
  # ============================================================================
  build-debian:
    name: Debian 13
    runs-on: ubuntu-24.04
    container:
      image: debian:trixie

    steps:
    - name: Install git for checkout
      run: apt-get update && apt-get install -y git

    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          libssl-dev \
          libboost-all-dev \
          librocksdb-dev \
          libcurl4-openssl-dev \
          libsodium-dev \
          libjsoncpp-dev \
          libzmq3-dev \
          libevent-dev \
          libqrencode-dev \
          libhidapi-dev \
          libxkbcommon-dev \
          qt6-base-dev \
          qt6-tools-dev \
          qt6-tools-dev-tools \
          libqt6svg6-dev

    - name: Cache liboqs
      id: cache-liboqs-debian
      uses: actions/cache@v4
      with:
        path: ~/liboqs
        key: debian-liboqs-0.15.0

    - name: Build liboqs
      if: steps.cache-liboqs-debian.outputs.cache-hit != 'true'
      run: |
        git clone --branch 0.15.0 https://github.com/open-quantum-safe/liboqs.git ~/liboqs-src
        cd ~/liboqs-src
        mkdir build && cd build
        cmake -GNinja -DCMAKE_INSTALL_PREFIX=$HOME/liboqs -DCMAKE_BUILD_TYPE=Release ..
        ninja
        ninja install

    - name: Cache RandomX
      id: cache-randomx-debian
      uses: actions/cache@v4
      with:
        path: ~/randomx
        key: debian-randomx-1.2.1

    - name: Build RandomX
      if: steps.cache-randomx-debian.outputs.cache-hit != 'true'
      run: |
        git clone --branch v1.2.1 https://github.com/tevador/RandomX.git ~/randomx-src
        cd ~/randomx-src
        mkdir build && cd build
        cmake -DCMAKE_INSTALL_PREFIX=$HOME/randomx -DCMAKE_BUILD_TYPE=Release ..
        make -j$(nproc)
        make install

    - name: Configure CMake
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
          -DCMAKE_PREFIX_PATH="$HOME/liboqs;$HOME/randomx" \
          -DBUILD_TESTS=ON \
          -DBUILD_WALLET_QT=ON \
          -GNinja

    - name: Build
      run: cmake --build build --config $BUILD_TYPE -j$(nproc)

    - name: Run tests
      working-directory: build
      timeout-minutes: 30
      run: ctest --output-on-failure -C $BUILD_TYPE --timeout 300 -E "(MetricsServerTest|IBDIntegrationTest)"

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: intcoin-debian-13
        path: |
          build/bin/intcoind
          build/bin/intcoin-cli
          build/bin/intcoin-wallet
          build/bin/intcoin-miner
          build/bin/intcoin-pool-server
          build/bin/intcoin-qt
        if-no-files-found: error

  # ============================================================================
  # Code Quality Checks
  # ============================================================================
  code-quality:
    name: Code Quality
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run clang-format check
      run: |
        find src include -name '*.cpp' -o -name '*.h' | xargs clang-format --dry-run --Werror || true

    - name: Check for TODOs
      run: |
        echo "::warning::TODO count: $(grep -r "TODO" src include | wc -l)"
        grep -r "FIXME" src include || echo "No FIXMEs found"

    - name: Check license headers
      run: |
        missing=0
        for file in $(find src include -name '*.cpp' -o -name '*.h'); do
          if ! grep -qE "Copyright \(c\) (2025|2026|2025-2026) INTcoin Team" "$file"; then
            echo "Missing license header: $file"
            missing=$((missing + 1))
          fi
        done
        if [ $missing -gt 0 ]; then
          echo "::warning::$missing files missing license headers"
        fi

  # ============================================================================
  # Release Creation (on tag push)
  # ============================================================================
  create-release:
    name: Create Release
    runs-on: ubuntu-24.04
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build-ubuntu, build-macos, build-fedora, build-debian]
    permissions:
      contents: write

    steps:
    - name: Install zip utility
      run: sudo apt-get update && sudo apt-get install -y zip

    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: Create release archives
      run: |
        cd intcoin-ubuntu-24.04
        tar -czf ../intcoin-${{ github.ref_name }}-ubuntu-24.04.tar.gz *
        cd ../intcoin-macos-latest
        tar -czf ../intcoin-${{ github.ref_name }}-macos-latest.tar.gz *
        cd ../intcoin-fedora-40
        tar -czf ../intcoin-${{ github.ref_name }}-fedora-40.tar.gz *
        cd ../intcoin-debian-13
        tar -czf ../intcoin-${{ github.ref_name }}-debian-13.tar.gz *
        cd ..

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          intcoin-${{ github.ref_name }}-ubuntu-24.04.tar.gz
          intcoin-${{ github.ref_name }}-macos-latest.tar.gz
          intcoin-${{ github.ref_name }}-fedora-40.tar.gz
          intcoin-${{ github.ref_name }}-debian-13.tar.gz
        draft: false
        prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
